name: httpz-gateway

services:
  anvil-node:
    container_name: anvil-node
    image: ghcr.io/foundry-rs/foundry:stable
    env_file:
      - ./.env.example.deployment
    entrypoint:
      [
        "anvil",
        "--block-time",
        "0.1",
        "--host",
        "0.0.0.0",
        "--port",
        "8546",
        "--chain-id",
        "54321",
        "--accounts",
        "15",
        "--mnemonic",
        "${MNEMONIC}",
      ]
    ports:
      - "8546:8546"
    volumes:
      - .:/anvil

  deploy-gateway-contracts:
    container_name: deploy-gateway-contracts
    image: gateway-l2/sc-bundle:0.1.0-local
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - gateway-l2/sc-bundle:0.1.0-local
    volumes:
      - ./.env.example.deployment:/app/.env
    command:
      - /bin/bash
      - "-c"
      - |
        source /app/.env
        # please replace with deploy-gateway-contracts.sh once ready
        /app/deploy-httpz-gateway-deployment.sh staging
    depends_on:
      anvil-node:
        condition: service_started

  add-httpz-networks:
    container_name: add-httpz-networks
    image: gateway-l2/sc-bundle:0.1.0-local
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - gateway-l2/sc-bundle:0.1.0-local
    volumes:
      - ./.env.example.deployment:/app/.env
    command:
      - /bin/bash
      - "-c"
      - |
        source /app/.env
        # please uncomment this line when script is ready
        # /app/add-httpz-networks.sh staging
    depends_on:
      anvil-node:
        condition: service_started
      deploy-gateway-contracts:
        condition: service_completed_successfully
